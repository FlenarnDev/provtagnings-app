<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Generera ny QR-kod</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body {
      background-color: #f5f7fa;
      font-family: "Segoe UI", sans-serif;
      padding: 2rem;
    }

    .header-container {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
    }

    .logo {
      height: 2.2em;
      margin-right: 0.75em;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    .sticky-bar {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
      position: sticky;
      top: 1rem;
      z-index: 1000;
    }

    .form-card {
      border-radius: 12px;
      border: none;
      transition: transform 0.2s ease, background-color 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .form-card:hover {
      transform: scale(1.02);
      background-color: #f8f9fb;
    }

    .form-card.selected {
      background-color: #e0f7ea;
      box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }

    .badge-filter {
      cursor: pointer;
      user-select: none;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      border-radius: 6px;
      margin-right: 0.5rem;
    }

    .qr-preview {
      display: none;
    }

    #print-label {
      display: none;
    }

    .label-preview {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 650px;
      margin: 1rem auto;
      border: 1px dashed #ccc;
    }

    .label-preview .label-info {
      flex: 1;
      padding-right: 2rem;
    }

    .label-preview img {
      width: 80px;
      height: 80px;
    }

    .loader {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 0.15em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header-container">
    <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 204.81 205.89">
      <defs>
        <style>
          .cls-1 { fill: #009640; }
          .cls-2 { fill: #0080c9; }
        </style>
      </defs>
      <path class="cls-1"
        d="m202.48,7.71c-2.68-3-20.39-3.88-25.59-3.74-1.78.05-2.45.8-2.8,2.13-.25.96-.87,6.51-1.3,16.81-.69,29.42-4.61,96.59-11.99,125.08-6.84,26.4-12.73,30.99-18.66,29.46-3.06-.79-8.59-3.05-12.56-5.09,0,0-67.27-29.35-73.77-31.04-7.08-1.83-9.74,1.35-10.93,5.94-1.29,4.97.77,34.86.36,43.53-.2,6.28-.6,13.32,6.29,15.1l101.68-.27c8.56,0,10.37-2.21,14.24-17.13,5.75-22.18,10.15-48.6,11.92-70.39,0,0,4.74-64.7,5.3-72.52.64-8.78,16-.72,17.87-4.72,3.41-7.3,2.61-30.15-.07-33.15Z" />
      <path class="cls-2"
        d="m147.06,98.57c4.89-3.65,11.47-8.64,12.95-14.65,3.3-13.44,4.18-60.25-9.65-68.77C132.41,4.09,37.07-7.18,31.73,5.84c-6.67,16.25,11.62,37.15,28.89,54.62l54.31,49.91c5.72,5.69,26.83,23.75,20.42,30.77-5.45,5.97-36.32-23.29-42.48-28.87l-45.65-44.39c-3.8-3.57-11.5-8.08-17.84-9.63-10.74-2.64-15.9,13.38-22.04,38.33-3.73,15.16-9.41,33.29-6.59,44.16,2.68,10.63,10.72,20.13,21.66,22.82,4.41,1.09,7.38-1.03,8.27-4.68,2.55-10.36-19.11-9.99-15.01-26.68,3.25-13.24,19.32-19.86,31.8-16.8,3.84.95,12.82,4.98,16.23,6.84l47.64,26.36c4.66,2.57,24.2,14.81,34.77,1.55,20.49-25.7-22.43-68.2-38.48-80.3-16.71-12.97-69.89-42.59-60.78-55.29,7.2-10.04,91.53,20.65,96.71,60.79.47,3.66-2.86,13.68-4.69,15.59,0,0-2.47,2.7.09,5.49,4.01,4.38,8.1,2.13,8.1,2.13Z" />    
    </svg>
    <h1>Generera etikett</h1>
    <a href="/dashboard" class="btn btn-outline-primary ms-auto">Startsida</a>
  </div>

  <!-- Controls -->
  <div class="sticky-bar">
    <div class="mb-3 d-flex justify-content-between align-items-center">
      <input type="text" id="search-box" class="form-control me-3" style="flex: 1" placeholder="Sök efter provtyp/provpunkt eller verk..." />
      <select id="sort-select" class="form-select w-auto ms-3">
        <option value="name">Sortera: Namn (A–Ö)</option>
        <option value="position">Sortera: Verk</option>
        <option value="category">Sortera: Kategori</option>
      </select>
    </div>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span class="badge bg-success badge-filter" onclick="filterByCategory('Givarprov')">Givarprov</span>
        <span class="badge bg-info text-dark badge-filter" onclick="filterByCategory('Dricksvatten')">Dricksvatten</span>
        <span class="badge bg-secondary badge-filter" onclick="clearCategoryFilter()">Alla</span>
      </div>
      <button class="btn btn-primary" onclick="generateAndPrintQRCode()">Skriv ut etikett</button>
    </div>
  </div>

  <!-- Alert -->
  <div id="select-label-alert" class="alert alert-danger d-none mt-3" role="alert">
    Vänligen välj en provstyp.
  </div>

  <!-- Label Preview -->
  <div id="label-preview-container" class="label-preview d-none">
    <div class="label-info">
      <div id="preview-name" class="fw-bold"></div>
      <div id="preview-position" class="text-muted small"></div>
      <div id="preview-category" class="fst-italic small"></div>
    </div>
    <img id="preview-qr" src="" alt="QR Preview" />
  </div>

  <!-- Form Cards -->
  <div class="row row-cols-1 row-cols-md-3 g-3" id="form-type-container"></div>

  <!-- Hidden Label Layout -->
  <div id="print-label">
    <div class="label-info" id="label-info">
      <div id="label-name"></div>
      <div id="label-id" style="font-size: 10pt;"></div>
      <div id="label-category" style="font-size: 10pt; font-style: italic;"></div>
    </div>
    <canvas id="label-qr"></canvas>
  </div>

  <script>
    let allForms = [];
    let selectedForm = null;

    const categoryMap = {
      'GP': 'Givarprov',
      'DV': 'Dricksvatten'
    };

    function getCategory(formType) {
      return categoryMap[formType.substring(0, 2).toUpperCase()] || 'Other';
    }

    async function loadFormTypes() {
      try {
        const res = await fetch('/api/formDeclarations');
        const forms = await res.json();
        allForms = forms.map(f => ({ ...f, category: getCategory(f.formType) }));
        renderForms(allForms);
      } catch (err) {
        alert('Kunde inte ladda formulärtyper.');
        console.error(err);
      }
    }

    function renderForms(forms) {
      const container = document.getElementById('form-type-container');
      container.innerHTML = '';

      forms.forEach(form => {
        const card = document.createElement('div');
        card.className = 'col';
        card.innerHTML = `
          <div class="card form-card" data-id="${form.id}">
            <div class="card-body">
              <h5 class="card-title">${form.formName}</h5>
              <p class="card-text text-muted">${form.formPosition}</p>
              <span class="badge bg-${form.category === 'Givarprov' ? 'success' : form.category === 'Dricksvatten' ? 'info text-dark' : 'secondary'}">
                ${form.category}
              </span>
            </div>
          </div>
        `;

        card.querySelector('.form-card').addEventListener('click', function () {
          document.querySelectorAll('.form-card').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          selectedForm = form;
          showPreview(form);
        });

        container.appendChild(card);
      });
    }

    function showPreview(form) {
      const preview = document.getElementById('label-preview-container');
      preview.classList.remove('d-none');

      document.getElementById('preview-name').textContent = form.formName;
      document.getElementById('preview-position').textContent = form.formPosition;
      document.getElementById('preview-category').textContent = form.category;

      const url = `https://labb.svaab.se/qr=${form.id.toString(16)}-preview`;
      QRCode.toDataURL(url, { width: 80 }, (err, dataUrl) => {
        if (!err) {
          document.getElementById('preview-qr').src = dataUrl;
        }
      });
    }

    async function generateAndPrintQRCode() {
      if (!selectedForm) {
        document.getElementById('select-label-alert').classList.remove('d-none');
        setTimeout(() => {
          document.getElementById('select-label-alert').classList.add('d-none');
        }, 2500);
        return;
      }

      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = `<span class="loader"></span> Skriver ut...`;
      btn.disabled = true;

      try {
        const res = await fetch('/api/typed-entry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ formType: selectedForm.id })
        });

        const { highestUniqueId } = await res.json();
        const fullURL = `https://labb.svaab.se/qr=${selectedForm.id.toString(16)}-${highestUniqueId.toString(16)}`;

        const canvas = document.createElement('canvas');
        await QRCode.toCanvas(canvas, fullURL, { width: 250 });

        const qrDataUrl = canvas.toDataURL();

        const printFrame = document.getElementById('print-frame') || (() => {
          const f = document.createElement('iframe');
          f.id = 'print-frame';
          f.style.position = 'absolute';
          f.style.top = '-9999px';
          document.body.appendChild(f);
          return f;
        })();

        const doc = printFrame.contentDocument || printFrame.contentWindow.document;
        doc.open();
        doc.write(`
          <html><head><style>
          @page { size: 10cm 3cm; margin: 0; }
          body { margin: 0; padding: 0; width: 10cm; height: 3cm; }
          #label { display: flex; justify-content: space-between; padding: 0.4cm; font-size: 12pt; box-sizing: border-box; background: white; }
          .info { flex: 1; padding-right: 1cm; }
          img { width: 2.5cm; height: 2.5cm; }
          </style></head><body>
          <div id="label">
            <div class="info">
              <div>${selectedForm.formName}</div>
              <div style="font-size: 10pt;">${selectedForm.formPosition}</div>
              <div style="font-size: 10pt; font-style: italic;">${selectedForm.category}</div>
            </div>
            <img src="${qrDataUrl}" />
          </div>
          </body></html>
        `);
        doc.close();

        setTimeout(() => {
          printFrame.contentWindow.focus();
          printFrame.contentWindow.print();
        }, 500);
      } catch (err) {
        alert('Fel vid utskrift.');
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function filterByCategory(category) {
      renderForms(allForms.filter(f => f.category === category));
    }

    function clearCategoryFilter() {
      renderForms(allForms);
    }

    document.getElementById('search-box').addEventListener('input', function () {
      const val = this.value.toLowerCase();
      const filtered = allForms.filter(f =>
        f.formName.toLowerCase().includes(val) ||
        f.formType.toLowerCase().includes(val) ||
        f.formPosition.toLowerCase().includes(val)
      );
      renderForms(filtered);
    });

    document.getElementById('sort-select').addEventListener('change', function () {
      const val = this.value;
      const sorted = [...allForms].sort((a, b) => {
        if (val === 'name') return a.formName.localeCompare(b.formName);
        if (val === 'position') return a.formPosition.localeCompare(b.formPosition);
        if (val === 'category') return a.category.localeCompare(b.category);
        return 0;
      });
      renderForms(sorted);
    });

    window.onload = loadFormTypes;
  </script>
</body>
</html>
